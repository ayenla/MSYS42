{% extends 'msys42app/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid pt-4 pb-3">
    <div class="d-flex align-items-center">
        <div class="search-container">
            <input type="text" id="searchInput" class="form-control search-input" placeholder="Search by code or name..." value="{{ search_query }}">
            <div id="clearSearch" class="clear-search-btn {% if not search_query %}d-none{% endif %}">
                <!-- X icon for clearing search -->
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                </svg>
            </div>
        </div>

        <!-- SVG Button Trigger -->
        <button id="filterBtn" type="button" class="btn btn-light d-flex align-items-center justify-content-center p-2" style="width: 40px; height: 40px; margin-left: 2px;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-sliders" viewBox="0 0 16 16" width="20" height="20">
              <path fill-rule="evenodd" d="M11.5 2a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M9.05 3a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0V3zM4.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M2.05 8a2.5 2.5 0 0 1 4.9 0H16v1H6.95a2.5 2.5 0 0 1-4.9 0H0V8zm9.45 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m-2.45 1a2.5 2.5 0 0 1 4.9 0H16v1h-2.05a2.5 2.5 0 0 1-4.9 0H0v-1z"/>
            </svg>
        </button>
          
  
        
        <div id="customModal" class="card shadow-sm p-3 bg-white rounded-5 d-none position-absolute" 
        style="width: 300px; height: fit-content; font-size: smaller; font-weight: 500;">
            <!-- Modal Header -->
            <div class="d-flex justify-content-between align-items-center border-bottom pb-1 mb-1">
              <h6 class="mb-0">Filter Child Profiles</h6>
              <button type="button" id="closeModal" aria-label="Close"
              style="background: transparent; border: none; font-size: 1.2rem; cursor: pointer;">&times;</button>

            </div>
          
            <!-- Modal Body -->
            <form id="filterForm">
              <div class="modal-body p-1">
                <!-- Sex -->
                <div class="form-group d-flex align-items-center mb-2">
                  <label class="me-2 mb-0" style="min-width: 60px;">Sex</label>
                  <select class="form-control form-control-sm" name="sex" id="sex" style="flex: 1;">
                    <option value="">Any</option>
                    <option value="Male" {% if selected_sex == "Male" %}selected{% endif %}>Male</option>
                    <option value="Female" {% if selected_sex == "Female" %}selected{% endif %}>Female</option>
                  </select>
                </div>
          
                <!-- Age Range -->
                <div class="form-group d-flex align-items-center mb-2">
                  <label class="me-2 mb-0 text-end" style="min-width: 90px;">Age Range</label>
                  <input type="number" name="age_min" class="form-control form-control-sm me-1 mr-2" style="width:75px" placeholder="Min" min="0" value="{{ age_min }}">
                  <input type="number" name="age_max" class="form-control form-control-sm ml-2" style="width:75px" placeholder="Max" min="0" value="{{ age_max }}">
                </div>
          
                <!-- Condition -->
                <div class="form-group d-flex align-items-center mb-2">
                  <label class="me-2 mb-0" style="min-width: 90px;">Condition</label>
                  <select class="form-control form-control-sm" name="condition" id="condition" style="flex: 1;">
                    <option value="">Select</option>
                    {% for val, label in allergies_conditions %}
                      <option value="{{ val }}" {% if val == selected_condition %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
          
                <!-- BMI -->
                <div class="form-group d-flex justify-content-between align-items-center mb-1">
                    <label class="mb-0 text-end" style="min-width: 60px;">BMI</label>
                    <div class="d-flex">
                      <input type="number" name="bmi_min" class="form-control form-control-sm me-2 mr-2" style="width:75px;" placeholder="Min" min="0" value="{{ bmi_min }}">
                      <input type="number" name="bmi_max" class="form-control form-control-sm ml-2" style="width:75px;" placeholder="Max" min="0" value="{{ bmi_max }}">
                    </div>
                </div>
            </div>
          
              <!-- Modal Footer -->
              <div class="modal-footer pb-0 pt-2 pr-0 d-flex justify-content-end gap-2" >
                <a href="{% url 'home' %}" class="btn btn-outline-danger btn-sm">Clear</a>
                <button type="submit" class="btn btn-sm btn-primary">Apply</button>
              </div>
            </form>
          </div>
          
          

        {% if perms.can_create %}
        <a class="btn btn-success create-btn" href="{% url 'create_child_profile' %}">Create Child Profile</a>
        {% endif %}
    </div>
</div>

<style>
    .pt-4 {
        padding-top: 1.5rem;
    }
    .pb-3 {
        padding-bottom: 1rem;
    }
    .search-container {
        position: relative;
    }
    .search-input {
        width: 300px;
    }
    .clear-search-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }
    .slider-icon {
        height: 35px;
        cursor: pointer;
        padding-left: 5px;
        padding-right: 5px;
    }
    .create-btn {
        width: 200px;
        border-radius: 10px;
        margin-left: 20px;
    }

    .btn-active {
        background-color: #d6d6d6 !important; /* Darker shade */
        border-color: #ccc !important;
    }

    #filterBtn:hover {
        cursor: pointer;
    }

</style>

<div class="container-fluid mt-2">
    <table class="table table-bordered table-striped text-left">
        <thead class="table-dark">
            <tr>
                <th>SPC Code</th>
                <th>Last Name</th>
                <th>First Name</th>
                <th>Middle Name</th>
                <th>Sex</th>
                <th>Age</th>
                <th>Guardian</th>
                <th>Communication Address</th>
                <th>Contact No.</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="childrenTableBody">
            {% for child in children %}
            <tr>
                <td>{{ child.spc_code }}</td>
                <td>{{ child.last_name }}</td>
                <td>{{ child.first_name }}</td>
                <td>{{ child.middle_name }}</td>
                <td>{{ child.sex }}</td>
                <td>{{ child.age }}</td>
                <td>{{ child.guardian_lastname }}, {{ child.guardian_firstname }}</td>
                <td>{{ child.comm_address }}</td>
                <td>
                    {% for number in child.phone_numbers.all %}
                        {{ number.number }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </td>
                <td>
                    <a class="btn btn-primary btn-sm" href="{% url 'view_child_profile' pk=child.pk%}">View</a>
                </td>
            </tr>
            {% empty %}
            <tr id="noResultsRow">
                <td colspan="10" class="text-center">
                    {% if search_query %}
                        No child profiles match for "{{ search_query }}"
                    {% else %}
                        No child profiles available.
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        
        // Show/hide clear button based on input content
        searchInput.addEventListener('input', function() {
            if (this.value) {
                clearSearch.classList.remove('d-none');
            } else {
                clearSearch.classList.add('d-none');
            }
            
            // Perform instant search
            performSearch(this.value);
        });
        
        // Clear search when X is clicked
        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            clearSearch.classList.add('d-none');
            performSearch('');
        });
        
        // Function to perform AJAX search
        function performSearch(query) {
            // Create AJAX request
            const xhr = new XMLHttpRequest();
            xhr.open('GET', `?q=${encodeURIComponent(query)}`, true);
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Extract the table body from the response
                    const responseHtml = xhr.responseText;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(responseHtml, 'text/html');
                    const newTableBody = doc.getElementById('childrenTableBody');
                    
                    if (newTableBody) {
                        document.getElementById('childrenTableBody').innerHTML = newTableBody.innerHTML;
                    }
                }
            };
            
            xhr.send();
        }
    });

    const filterBtn = document.getElementById('filterBtn');
const modal = document.getElementById('customModal');
const closeBtn = document.getElementById('closeModal');

filterBtn.addEventListener('click', (e) => {
  const rect = filterBtn.getBoundingClientRect();

  // Adjust these to control placement
  const offsetX = -10; // pixels to the right of button
  const offsetY = -40;  // vertically aligned

  // Position the modal right next to the button
  modal.style.top = `${rect.top + offsetY}px`;
  modal.style.left = `${rect.right + offsetX}px`;

  modal.classList.toggle('d-none');
});

closeBtn.addEventListener('click', () => {
  modal.classList.add('d-none');
});

document.addEventListener('click', (e) => {
  if (!modal.contains(e.target) && !filterBtn.contains(e.target)) {
    modal.classList.add('d-none');
  }
});

    document.getElementById('filterBtn').addEventListener('click', function () {
    this.classList.toggle('btn-active');
  });


</script>
{% endblock %}
